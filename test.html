<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
  </head>
  <body>
    <h1 class="grapevine-money">$350</h1>
    <h2 class="grapevine-visits">53 visits</h2>

    <script>
      var thisPeer = new Peer(timeInSeconds(), {key: 'lwjd5qra8257b9'});
      console.log('my id is',thisPeer.id);

      function timeInSeconds() {
        return Math.round((new Date()).getTime()/1000);
      }

      var peers = [];

      // attempt connection every second
      // var interval;
      // function start(){
      //   interval = setInterval(function(){
      //     var testId = String(timeInSeconds() - 2);
      //     // console.log('trying',testId);
      //     thisPeer.connect(testId);
      //   }, 1000);
      // }

      // function stop() {
      //   window.clearInterval(interval);
      // }

      function connect(peerId){
        peer = thisPeer.connect(peerId);
        handleOpenConnection(peer);
      }

      function updateClassWithContent(className, content) {
        var update = {class:className, content:content};
        // update self
        updateElementByClass(update.class, update.content);
        // tell peers to update selves
        peers.forEach(function(peer){
          peer.send(update);
        });
      };

      // connection attempt
      thisPeer.on('connection', function(peer) {
        handleOpenConnection(peer);
      });

      function handleOpenConnection(peer){
        // connection open
        peer.on('open', function(){
          peers.push(peer);
          console.log('connection opened with', peer.peer);

          // message received
          peer.on('data', function(update) {
            console.log('data from', peer, 'sent', update);
            updateElementByClass(update.class, update.content);
          });
        });
      }

      function updateElementByClass(className, content) {
        var elementsToUpdate = document.getElementsByClassName(className);
        for(var i = 0; i < elementsToUpdate.length; i++){
          elementsToUpdate[i].textContent = content;
        }
      }

    </script>
  </body>
</html>
